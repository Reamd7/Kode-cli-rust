# Kode-Rust 项目目标

## 📋 项目概述

**项目名称**: Kode-Rust
**基于项目**: [Kode-cli](https://github.com/shareAI-lab/kode)
**开发语言**: Rust
**目标**: 使用 Rust 完整重写 Kode-cli，提供更高性能、更好体验的 AI Agent CLI 工具

### 项目路径
- **原始 TS 版本仓库**: `/Users/gemini/Documents/backup/Kode-cli`
- **当前 Rust 版本仓库**: `/Users/gemini/Documents/backup/Kode-cli-rust`
- **参考实现**: 开发时参考原 TS 版本的实现细节和配置格式

## 🎯 核心目标

### 1. 完整功能移植 ✅

将 TypeScript 版本的所有核心功能迁移到 Rust：

#### 1.1 多模型支持
- [x] **需求明确**: 支持多个 AI 模型提供商
- [ ] **实现范围**:
  - Anthropic Claude API (优先)
  - OpenAI-compatible APIs (OpenAI, DeepSeek, etc.)
  - AWS Bedrock (可选)
  - Google Vertex AI (可选)
- [ ] **功能点**:
  - 模型配置文件管理 (`modelProfiles`)
  - 模型指针系统 (default, task, reasoning, quick)
  - 运行时动态切换模型
  - 统一的 `ModelAdapter` 接口

#### 1.2 Agent 系统
- [x] **需求明确**: 动态 Agent 配置加载
- [ ] **实现范围**:
  - Agent 定义格式: Markdown + YAML frontmatter
  - 5 层优先级加载系统
  - Agent 工具过滤 (all 或指定列表)
  - Agent 专用模型配置
  - LRU 缓存优化
- [ ] **加载优先级**:
  1. Built-in (代码内嵌)
  2. `~/.claude/agents/` (Claude Code 兼容)
  3. `~/.kode/agents/` (Kode 用户目录)
  4. `./.claude/agents/` (项目 Claude Code 兼容)
  5. `./.kode/agents/` (项目 Kode 目录)

#### 1.3 工具系统
- [x] **需求明确**: 完整工具生态
- [ ] **核心工具实现**:
  - `FileReadTool`: 读取文件
  - `FileWriteTool`: 写入文件
  - `FileEditTool`: 精确编辑（字符串替换）
  - `BashTool`: 执行 shell 命令
  - `GrepTool`: 代码搜索 (ripgrep)
  - `GlobTool`: 文件模式匹配
  - `TaskTool`: 委托任务给子 Agent
- [ ] **工具系统设计**:
  - Trait-based 架构
  - 工具注册表 (`ToolRegistry`)
  - 动态工具过滤
  - 权限系统集成

#### 1.4 MCP (Model Context Protocol) 集成
- [x] **需求明确**: 支持 MCP 协议
- [ ] **实现范围**:
  - MCP 客户端实现
  - MCP 服务器配置 (`mcpServers`)
  - 动态工具发现
  - MCP 工具调用
  - 与内置工具统一接口

#### 1.5 上下文管理
- [x] **需求明确**: 智能上下文窗口管理
- [ ] **实现范围**:
  - 消息历史管理
  - Token 计数
  - 自动裁剪策略
  - 上下文优先级
  - 持久化内存 (可选)

#### 1.6 权限系统
- [x] **需求明确**: 安全的工具执行
- [ ] **实现范围**:
  - 工具权限检查
  - 用户批准对话框
  - 权限记忆 (session 级别)
  - 文件路径沙箱
  - 危险操作警告

#### 1.7 TUI 界面
- [x] **需求明确**: 现代化终端界面
- [ ] **实现范围**:
  - REPL 交互界面
  - 消息滚动列表
  - 输入框 + 多行支持
  - 实时流式输出
  - 语法高亮 (代码块)
  - 状态栏 (模型、token 计数)
  - 加载动画
  - 错误提示

### 2. 配置兼容性 ✅

**目标**: 与原 TypeScript 版本完全兼容

#### 2.1 配置文件兼容
- [x] **需求明确**: 使用相同的 `.kode.json` 格式
- [ ] **兼容性检查**:
  - 全局配置: `~/.kode.json`
  - 项目配置: `./.kode.json`
  - 配置合并逻辑
  - 环境变量覆盖
  - JSON 格式完全兼容
- [ ] **测试要求**:
  - 加载原版配置文件
  - 修改后原版可读
  - 所有字段正确解析

#### 2.2 Agent 定义兼容
- [x] **需求明确**: 支持相同的 Agent 格式
- [ ] **兼容性检查**:
  - Markdown 文件 + YAML frontmatter
  - 相同的字段名称
  - 相同的目录结构
  - 相同的加载优先级
- [ ] **测试要求**:
  - 加载原版 Agent 文件
  - 修改后原版可读
  - 工具过滤逻辑一致

#### 2.3 MCP 协议兼容
- [x] **需求明确**: 符合 MCP 规范
- [ ] **兼容性检查**:
  - MCP 服务器配置格式
  - MCP 协议实现
  - 与现有 MCP 服务器互操作
- [ ] **测试要求**:
  - 连接 TS 版本配置的 MCP 服务器
  - 工具调用结果一致

### 3. 性能目标 🚀

**目标**: 充分利用 Rust 的性能优势

#### 3.1 启动性能
- [ ] **目标**: 冷启动 < 100ms
- [ ] **优化方向**:
  - 懒加载非关键模块
  - 配置文件快速解析
  - 并行初始化
  - 减少依赖体积

#### 3.2 运行性能
- [ ] **目标**:
  - 配置加载 < 50ms
  - Agent 加载 < 20ms (缓存) / < 100ms (非缓存)
  - 工具执行框架开销 < 5ms
  - UI 渲染 60 FPS
- [ ] **优化方向**:
  - 异步 IO (Tokio)
  - 并发工具执行
  - LRU 缓存
  - 零拷贝优化

#### 3.3 内存使用
- [ ] **目标**:
  - 空闲 < 50MB
  - 活跃 < 200MB
- [ ] **优化方向**:
  - 流式处理大文件
  - 及时释放资源
  - 上下文裁剪
  - 内存池优化

#### 3.4 响应体验
- [ ] **目标**:
  - 首字节响应 < 500ms
  - 流式输出实时更新
  - UI 无卡顿
- [ ] **优化方向**:
  - SSE 流式响应
  - 异步渲染
  - 背景任务优先级
  - 用户输入即时响应

### 4. 开发体验 🛠️

#### 4.1 代码质量
- [ ] **目标**: 高质量 Rust 代码
- [ ] **标准**:
  - 遵循 Rust 最佳实践
  - 完整的类型注解
  - 清晰的模块划分
  - 充分的代码注释
  - Clippy 无警告
  - Rustfmt 格式化

#### 4.2 测试覆盖
- [ ] **目标**: 核心功能测试覆盖
- [ ] **测试类型**:
  - 单元测试 (每个模块)
  - 集成测试 (工作流)
  - 兼容性测试 (与 TS 版本)
  - 性能基准测试
- [ ] **覆盖要求**:
  - 核心逻辑 > 80%
  - 关键路径 100%

#### 4.3 文档完善
- [ ] **目标**: 完整的项目文档
- [ ] **文档清单**:
  - README.md (项目介绍)
  - ARCHITECTURE.md (架构设计)
  - GOALS.md (本文档)
  - ROADMAP.md (开发路线)
  - TECH_STACK.md (技术栈)
  - CONTRIBUTING.md (贡献指南)
  - API 文档 (rustdoc)
  - 用户手册

## 🎨 用户体验目标

### 5.1 交互流畅
- [ ] 实时流式输出，无需等待完整响应
- [ ] 60 FPS UI 渲染，无卡顿
- [ ] 快速启动，立即可用
- [ ] 响应式设计，适配不同终端尺寸

### 5.2 功能完整
- [ ] 所有 TS 版本功能均可用
- [ ] 工具执行稳定可靠
- [ ] Agent 系统灵活强大
- [ ] 多模型无缝切换

### 5.3 错误友好
- [ ] 清晰的错误提示
- [ ] 有用的调试信息
- [ ] 优雅的错误恢复
- [ ] 不丢失用户数据

### 5.4 易于使用
- [ ] 简单的配置流程
- [ ] 合理的默认值
- [ ] 详细的帮助信息
- [ ] 兼容原版配置，零学习成本

## 📊 成功标准

### 功能完整性
- [x] 所有核心功能列表已确定
- [ ] 所有核心工具已实现
- [ ] Agent 系统完全可用
- [ ] MCP 协议完全兼容
- [ ] 多模型支持已验证

### 兼容性验证
- [ ] 可加载原版 `.kode.json` 配置
- [ ] 可加载原版 Agent 定义
- [ ] 可连接原版 MCP 服务器
- [ ] 配置修改后原版可用

### 性能达标
- [ ] 启动时间 < 100ms
- [ ] 内存占用 < 50MB (idle)
- [ ] UI 渲染 60 FPS
- [ ] 工具执行开销 < 5ms

### 代码质量
- [ ] 核心逻辑测试覆盖 > 80%
- [ ] Clippy 无警告
- [ ] Rustfmt 已格式化
- [ ] API 文档完整

### 用户体验
- [ ] 流式输出实时显示
- [ ] 交互流畅无卡顿
- [ ] 错误提示清晰友好
- [ ] 配置简单易用

## 🚫 非目标

### 明确不在当前范围内的功能

1. **Web UI**: 仅专注于 TUI，不提供 Web 界面
2. **插件系统**: 暂不支持动态加载插件（未来可考虑）
3. **GUI 应用**: 不开发图形界面版本
4. **Windows 特定优化**: 主要支持 Unix-like 系统，Windows 为次要
5. **向后不兼容的改进**: 不修改配置格式，保持完全兼容
6. **移动端支持**: 不考虑移动设备
7. **分布式 Agent**: 暂不支持跨机器的 Agent 协作
8. **代码图谱**: 暂不集成向量数据库或代码图谱

## 📈 可选扩展目标

### 如果时间和资源允许

1. **AWS Bedrock 支持**: 完整的 Bedrock API 集成
2. **Google Vertex AI**: Vertex AI Claude 支持
3. **高级语法高亮**: 更多语言支持，主题配置
4. **会话管理**: 保存和恢复对话历史
5. **自定义 prompts**: 用户自定义系统提示词
6. **统计面板**: Token 使用统计、成本计算
7. **快捷键自定义**: 用户配置快捷键
8. **主题系统**: 多种 UI 主题

## 🔄 迭代策略

### MVP (Minimum Viable Product)
**Phase 1-2 完成后**:
- 基础 REPL 可用
- 单模型支持 (Claude)
- 核心工具可用
- 基础 Agent 系统
- 简单配置

### 功能完整版
**Phase 3 完成后**:
- 多模型支持
- 完整工具系统
- MCP 集成
- 权限系统
- 完善的 UI

### 优化版
**Phase 4 完成后**:
- 性能优化
- 测试覆盖
- 文档完善
- 发布就绪

## 🎓 学习目标

### 技术成长
- [x] 掌握 Rust 异步编程 (Tokio)
- [x] 掌握 TUI 开发 (Ratatui)
- [ ] 实践 Rust 工程化
- [ ] 实践 AI Agent 系统设计
- [ ] 实践流式 API 处理

### 工程实践
- [ ] 大型 Rust 项目组织
- [ ] 性能优化实践
- [ ] 跨平台兼容处理
- [ ] 开源项目维护

## 📝 总结

**核心目标**: 实现一个功能完整、性能优异、兼容原版的 Rust AI Agent CLI 工具

**关键指标**:
- ✅ 功能完整性: 100%
- ✅ 配置兼容性: 100%
- 🚀 启动性能: < 100ms
- 💾 内存占用: < 50MB
- 🎨 用户体验: 流畅、友好

**开发周期**: 10 周 (分 4 个阶段)

**成功标准**: 可以完全替代原 TypeScript 版本的日常使用
